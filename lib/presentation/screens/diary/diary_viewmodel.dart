import 'package:flutter/foundation.dart';
import 'package:pet_diary/data/models/diary_entry.dart';
import 'package:pet_diary/data/models/pet.dart';
import 'package:pet_diary/data/models/quota_status.dart';
import 'package:pet_diary/data/data_sources/remote/diary_api_service.dart';
import 'package:pet_diary/data/repositories/diary_repository.dart';
import 'package:pet_diary/data/repositories/pet_repository.dart';
import 'package:pet_diary/domain/services/quota_service.dart';

class DiaryViewModel extends ChangeNotifier {
  final DiaryRepository _diaryRepository = DiaryRepository();
  final PetRepository _petRepository = PetRepository();
  final DiaryApiService _diaryApiService = DiaryApiService();
  final QuotaService _quotaService = QuotaService();

  List<DiaryEntry> _entries = [];
  int _currentIndex = 0;
  bool _isLoading = false;
  String? _errorMessage;
  Pet? _currentPet;
  QuotaStatus _quotaStatus = const QuotaStatus();

  // Getters
  List<DiaryEntry> get entries => _entries;
  int get currentIndex => _currentIndex;
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;
  Pet? get currentPet => _currentPet;
  QuotaStatus get quotaStatus => _quotaStatus;

  /// å½“å‰æ˜¾ç¤ºçš„æ—¥è®°
  DiaryEntry? get currentEntry {
    if (_entries.isEmpty || _currentIndex >= _entries.length) {
      return null;
    }
    return _entries[_currentIndex];
  }

  /// æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
  bool get hasPrevious => _currentIndex > 0;

  /// æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
  bool get hasNext => _currentIndex < _entries.length - 1;

  /// åˆå§‹åŒ–
  Future<void> init() async {
    await loadData();
    await refreshQuotaStatus();
    await _autoGenerateRecentDiariesIfNeeded();
  }

  /// åˆ·æ–°é…é¢çŠ¶æ€
  Future<void> refreshQuotaStatus() async {
    try {
      _quotaStatus = await _quotaService.getQuotaStatus();
      _applyEntryAccessRules();
      debugPrint(
        'ğŸ“Š [Diary] AIé…é¢(å‰©ä½™/æ€»): ${_quotaStatus.freeQuotaRemaining}/${_quotaStatus.freeQuotaTotal}, '
        'å·²ç”¨: ${_quotaStatus.freeQuotaUsed}, ä¼šå‘˜: ${_quotaStatus.isPremium}',
      );
      notifyListeners();
    } catch (e) {
      debugPrint('âŒ [Diary] åˆ·æ–°é…é¢çŠ¶æ€å¤±è´¥: $e');
    }
  }

  /// åŠ è½½æ‰€æœ‰æ•°æ® â€” ä¼˜å…ˆä»æœåŠ¡ç«¯ï¼Œfallback åˆ°æœ¬åœ°
  Future<void> loadData() async {
    _isLoading = true;
    _errorMessage = null;
    notifyListeners();

    try {
      // åŠ è½½å® ç‰©ä¿¡æ¯
      _currentPet = await _petRepository.getCurrentPet();

      if (_currentPet != null) {
        // å°è¯•ä»æœåŠ¡ç«¯åŠ è½½æ—¥è®°
        final loaded = await _loadFromServer(_currentPet!.id);
        if (!loaded) {
          // Fallback åˆ°æœ¬åœ°
          debugPrint('[Diary] Server unavailable, loading from local');
          _entries = await _diaryRepository.getRecentEntries(limit: 30);
        }
      } else {
        _entries = await _diaryRepository.getRecentEntries(limit: 30);
      }

      _applyEntryAccessRules();
      debugPrint('âœ… æ•°æ®åŠ è½½å®Œæˆ');
      debugPrint('ğŸ“š [Diary] å½“å‰å±•ç¤ºæ—¥è®°æ•°é‡(æœåŠ¡ç«¯/æœ¬åœ°): ${_entries.length}');
    } catch (e) {
      _errorMessage = 'åŠ è½½æ•°æ®å¤±è´¥ï¼š$e';
      debugPrint('âŒ åŠ è½½é”™è¯¯: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _autoGenerateRecentDiariesIfNeeded() async {
    if (_currentPet == null) return;

    if (!_quotaStatus.canGenerateAI) {
      debugPrint('â„¹ï¸ [Diary] è‡ªåŠ¨ç”Ÿæˆè·³è¿‡ï¼šé…é¢ä¸è¶³');
      return;
    }

    final now = DateTime.now();
    final baseDay = DateTime(now.year, now.month, now.day);
    final targetDays = <DateTime>[
      baseDay,
      baseDay.subtract(const Duration(days: 1)),
      baseDay.subtract(const Duration(days: 2)),
    ];

    var remaining = _quotaStatus.freeQuotaRemaining;
    var generatedAny = false;

    try {
      for (final day in targetDays) {
        if (!_quotaStatus.isPremium && remaining <= 0) {
          break;
        }

        final dayStr =
            '${day.year}-${day.month.toString().padLeft(2, '0')}-${day.day.toString().padLeft(2, '0')}';

        DiaryEntry? existingEntry;
        for (final entry in _entries) {
          final d = DateTime(entry.date.year, entry.date.month, entry.date.day);
          if (d == day) {
            existingEntry = entry;
            break;
          }
        }

        if (existingEntry != null && existingEntry.content.trim().isNotEmpty) {
          continue;
        }

        debugPrint('ğŸ¤– [Diary] è‡ªåŠ¨å°è¯•ç”Ÿæˆæ—¥è®°: $dayStr');
        final response = await _diaryApiService.autoGenerateDiary(
          petId: _currentPet!.id,
          date: dayStr,
        );

        if (!response.success || response.data == null) {
          debugPrint('âš ï¸ [Diary] $dayStr è‡ªåŠ¨ç”Ÿæˆå¤±è´¥: ${response.errorMessage}');
          continue;
        }

        if (!response.data!.generated) {
          debugPrint('â„¹ï¸ [Diary] $dayStr æ— å¯ç”Ÿæˆå†…å®¹ï¼ˆç¼ºç…§ç‰‡æˆ–å·²æœ‰å†…å®¹ï¼‰');
          continue;
        }

        generatedAny = true;
        debugPrint(
          'âœ… [Diary] è‡ªåŠ¨ç”ŸæˆæˆåŠŸ: date=$dayStr, diaryId=${response.data!.diaryId}',
        );

        await _quotaService.recordAIUsage();
        if (!_quotaStatus.isPremium) {
          remaining--;
        }
      }

      if (generatedAny) {
        await refreshQuotaStatus();
        await loadData();
      }
    } catch (e) {
      debugPrint('âŒ [Diary] è‡ªåŠ¨ç”Ÿæˆæ—¥è®°å¼‚å¸¸: $e');
    }
  }

  void _applyEntryAccessRules() {
    if (_entries.isEmpty) return;

    if (_quotaStatus.isPremium) {
      _entries = _entries.map((e) => e.copyWith(isLocked: false)).toList();
      return;
    }

    // å…è´¹ç”¨æˆ·ä»…å¯æŸ¥çœ‹å‰ 3 ç¯‡æ—¥è®°ï¼ˆæŒ‰å½“å‰åˆ—è¡¨é¡ºåºï¼‰
    _entries = _entries.asMap().entries.map((item) {
      final index = item.key;
      final entry = item.value;
      final canView = index < 3;
      return entry.copyWith(isLocked: !canView);
    }).toList();
  }

  /// ä»æœåŠ¡ç«¯åŠ è½½æ—¥è®°åˆ—è¡¨ + è¯¦æƒ…ï¼ˆå« imageListï¼‰
  Future<bool> _loadFromServer(String petId) async {
    try {
      // 1. è·å–æ—¥è®°åˆ—è¡¨
      final listResponse = await _diaryApiService.getDiaryList(petId);
      if (!listResponse.success || listResponse.data == null) {
        debugPrint('[Diary] Failed to load diary list from server');
        return false;
      }

      final diaryList = listResponse.data!.diaryList;
      if (diaryList.isEmpty) {
        _entries = [];
        return true;
      }

      // 2. è·å–æ¯æ¡æ—¥è®°çš„è¯¦æƒ…ï¼ˆå« imageListï¼‰
      final entries = <DiaryEntry>[];
      for (final item in diaryList) {
        final detailResponse = await _diaryApiService.getDiaryDetail(
          petId: petId,
          diaryId: item.diaryId,
        );

        if (detailResponse.success && detailResponse.data != null) {
          final detail = detailResponse.data!;
          entries.add(DiaryEntry(
            id: item.diaryId,
            petId: petId,
            date: DateTime.tryParse(detail.date) ?? DateTime.now(),
            content: detail.content,
            imagePath: detail.avatar.isNotEmpty ? detail.avatar : null,
            imageUrls: detail.imageList,
            isLocked: false,
            createdAt: DateTime.tryParse(detail.date) ?? DateTime.now(),
          ));
        }
      }

      _entries = entries;
      debugPrint('[Diary] Loaded ${entries.length} entries from server');
      return true;
    } catch (e) {
      debugPrint('[Diary] Server load error: $e');
      return false;
    }
  }

  /// ç¿»åˆ°ä¸Šä¸€é¡µ
  void previousPage() {
    if (hasPrevious) {
      _currentIndex--;
      notifyListeners();
    }
  }

  /// ç¿»åˆ°ä¸‹ä¸€é¡µ
  void nextPage() {
    if (hasNext) {
      _currentIndex++;
      notifyListeners();
    }
  }

  /// è·³è½¬åˆ°æŒ‡å®šç´¢å¼•
  void jumpToIndex(int index) {
    if (index >= 0 && index < _entries.length) {
      _currentIndex = index;
      notifyListeners();
    }
  }

  /// åˆ é™¤æ—¥è®°
  Future<void> deleteEntry(String id) async {
    try {
      await _diaryRepository.deleteEntry(id);
      _entries = _entries.where((e) => e.id != id).toList();
      if (_currentIndex >= _entries.length && _currentIndex > 0) {
        _currentIndex = _entries.length - 1;
      }
      notifyListeners();
      debugPrint('âœ… æ—¥è®°å·²åˆ é™¤');
    } catch (e) {
      _errorMessage = 'åˆ é™¤å¤±è´¥ï¼š$e';
      notifyListeners();
      debugPrint('âŒ åˆ é™¤æ—¥è®°é”™è¯¯: $e');
    }
  }
}
